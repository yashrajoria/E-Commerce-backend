# CI for AWS deployments â€” build/test, build Docker images, and optionally deploy to EC2.
# Required GitHub Secrets (placeholders):
# - DOCKERHUB_USERNAME
# - DOCKERHUB_TOKEN
# - AWS_ACCESS_KEY_ID
# - AWS_SECRET_ACCESS_KEY
# - EC2_HOST (optional)
# - EC2_USER (optional)
# - EC2_SSH_KEY (optional, private key)
#
# Notes:
# - Place deploy scripts in `backend/infrastructure/aws/` (for example `deploy_to_ec2.sh`).
# - Migrations can be run via SSH to hosts with DB access or via separate migration runners.
# - After deploy, test health endpoints (e.g., `GET /health`) against the public endpoint or EC2 host.

name: CI - aws-deployment

on:
  push:
    branches: [ aws-deployment ]

jobs:
  build-and-test:
    name: Build and test services
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        service:
          - auth-service
          - bff-service
          - cart-service
          - inventory-service
          - order-service
          - payment-service
          - product-service
          - user-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: backend/services/${{ matrix.service }}/go.sum

      - name: Download modules
        run: go mod download
        working-directory: backend/services/${{ matrix.service }}

      - name: Run tests
        run: go test ./... -v
        working-directory: backend/services/${{ matrix.service }}

  docker-build-and-push:
    name: Build and push Docker images
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        service:
          - auth-service
          - bff-service
          - cart-service
          - inventory-service
          - order-service
          - payment-service
          - product-service
          - user-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: "yash263"
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ./backend/services/${{ matrix.service }}
          file: ./backend/services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  # deploy-to-ec2:
  #   name: Deploy to EC2 (optional)
  #   needs: docker-build-and-push
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15
  #   if: ${{ secrets.EC2_HOST != '' && secrets.EC2_SSH_KEY != '' }}
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Deploy to EC2 via SSH
  #       uses: appleboy/ssh-action@v1.0.3
  #       with:
  #         host: ${{ secrets.EC2_HOST }}
  #         username: ${{ secrets.EC2_USER }}
  #         key: ${{ secrets.EC2_SSH_KEY }}
  #         script: |
  #           set -euo pipefail
  #           DEPLOY_SCRIPT="$HOME/deploy_to_ec2.sh"
  #           if [ -f "${DEPLOY_SCRIPT}" ]; then
  #             bash "${DEPLOY_SCRIPT}"
  #           else
  #             echo "ERROR: ${DEPLOY_SCRIPT} not found on host. Aborting." >&2
  #             exit 1
  #           fi
