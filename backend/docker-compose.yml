services:
  postgres:
    image: postgres:latest
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ecommerce
      POSTGRES_HOST_AUTH_METHOD: md5
    ports:
      - "5432:5432"
    command: ["postgres", "-c", "listen_addresses=*"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    volumes:
      - postgres_data:/var/lib/postgresql
    networks:
      - ecommerce-network

  redis:
    image: redis:7
    restart: unless-stopped
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    volumes:
      - redis_data:/data
    networks:
      - ecommerce-network

  # ── NEW: OpenSearch for search-service ──────────────────────────────────────
  # opensearch:
  #   image: opensearchproject/opensearch:2.11.0
  #   restart: unless-stopped
  #   environment:
  #     - discovery.type=single-node
  #     - DISABLE_SECURITY_PLUGIN=true # fine for local dev
  #     - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m
  #   ports:
  #     - "9200:9200"
  #   healthcheck:
  #     test:
  #       [
  #         "CMD-SHELL",
  #         "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'",
  #       ]
  #     interval: 15s
  #     timeout: 10s
  #     retries: 10
  #     start_period: 30s
  #   volumes:
  #     - opensearch_data:/usr/share/opensearch/data
  #   networks:
  #     - ecommerce-network

  # # ── NEW: Jaeger for distributed tracing (Feature 6) ─────────────────────────
  # jaeger:
  #   image: jaegertracing/all-in-one:1.52
  #   restart: unless-stopped
  #   ports:
  #     - "16686:16686" # Jaeger UI
  #     - "4317:4317" # OTLP gRPC
  #     - "4318:4318" # OTLP HTTP
  #   environment:
  #     - COLLECTOR_OTLP_ENABLED=true
  #   healthcheck:
  #     test: ["CMD-SHELL", "wget -qO- http://localhost:16686 > /dev/null"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - ecommerce-network

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/auth-service:/app
      - ./services/common:/common
    ports:
      - "8081:8081"
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: SNS topic for publishing user_registered events ──
      - AUTH_SNS_TOPIC_ARN=${AUTH_SNS_TOPIC_ARN:-}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=auth-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecommerce-network

  user-service:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/user-service:/app
      - ./services/common:/common
    ports:
      - "8085:8085"
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=user-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecommerce-network

  product-service:
    build:
      context: .
      dockerfile: services/product-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/product-service:/app
      - ./services/common:/common
    ports:
      - "8082:8082"
    env_file:
      - .env
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_EC2_METADATA_DISABLED=true
      - USE_LOCALSTACK=${USE_LOCALSTACK:-true}
      - LOCALSTACK_ENDPOINT=${LOCALSTACK_ENDPOINT:-http://localstack:4566}
      - AWS_S3_BUCKET=shopswift
      - AWS_S3_PREFIX=products/
      - DDB_TABLE_PRODUCTS=Products
      - DDB_TABLE_CATEGORIES=Categories
      - INVENTORY_SERVICE_URL=http://inventory-service:8084
      - CLOUDWATCH_ENABLED=true
      - CLOUDWATCH_LOG_GROUP=/ecommerce/services
      - CLOUDWATCH_NAMESPACE=ECommerce
      # ── NEW: SNS topic so product-service publishes product_created/updated ──
      - PRODUCT_SNS_TOPIC_ARN=${PRODUCT_SNS_TOPIC_ARN:-}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=product-service
    networks:
      - ecommerce-network

  cart-service:
    build:
      context: .
      dockerfile: services/cart-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/cart-service:/app
      - ./services/common:/common
    ports:
      - "8086:8086"
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=cart-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ecommerce-network

  inventory-service:
    build:
      context: .
      dockerfile: services/inventory-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/inventory-service:/app
    ports:
      - "8084:8084"
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - DDB_TABLE=${DDB_TABLE:-Inventory}
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=inventory-service
    networks:
      - ecommerce-network

  order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/order-service:/app
    ports:
      - "8083:8083"
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - INVENTORY_SERVICE_URL=${INVENTORY_SERVICE_URL:-http://inventory-service:8084}
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: SNS topic for order events ──
      - ORDER_SNS_TOPIC_ARN=${ORDER_SNS_TOPIC_ARN:-}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=order-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecommerce-network

  payment-service:
    build:
      context: .
      dockerfile: services/payment-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/payment-service:/app
      - ./services/common:/common
    ports:
      - "8087:8087"
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: SNS topic for payment events ──
      - PAYMENT_SNS_TOPIC_ARN=${PAYMENT_SNS_TOPIC_ARN:-}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=payment-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecommerce-network

  promotion-service:
    build:
      context: .
      dockerfile: services/promotion-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/promotion-service:/app
    ports:
      - "8090:8090"
    env_file:
      - .env
    environment:
      - PORT=8090
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - PROMOTION_SNS_TOPIC_ARN=${PROMOTION_SNS_TOPIC_ARN:-}
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=promotion-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecommerce-network

  shipping-service:
    build:
      context: .
      dockerfile: services/shipping-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/shipping-service:/app
    ports:
      - "8091:8091"
    env_file:
      - .env
    environment:
      - PORT=8091
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - SHIPPO_API_KEY=${SHIPPO_API_KEY:-}
      - SHIPPING_SNS_TOPIC_ARN=${SHIPPING_SNS_TOPIC_ARN:-}
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=shipping-service
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecommerce-network

  # ── NEW: Notification Service (Feature 3) ───────────────────────────────────
  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/notification-service:/app
    ports:
      - "8092:8092"
    env_file:
      - .env
    environment:
      - PORT=8092
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      # SQS queue that receives all notification events from SNS
      - SQS_QUEUE_URL=${NOTIFICATION_SQS_QUEUE_URL:-}
      # SMTP config
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_EMAIL:-}
      - SMTP_PASS=${SMTP_PASSWORD:-}
      # Twilio config
      # - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      # - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      # - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER:-}
      # Postgres (for notification logs)
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=ecommerce
      - POSTGRES_SSLMODE=disable
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=notification-service
    depends_on:
      postgres:
        condition: service_healthy
      # jaeger:
      #   condition: service_healthy
    networks:
      - ecommerce-network

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./api-gateway:/app
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - AWS_ENDPOINT=${AWS_ENDPOINT:-}
      - CLOUDWATCH_ENABLED=${CLOUDWATCH_ENABLED:-false}
      - CLOUDWATCH_LOG_GROUP=${CLOUDWATCH_LOG_GROUP:-/ecommerce/services}
      - CLOUDWATCH_NAMESPACE=${CLOUDWATCH_NAMESPACE:-ECommerce}
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=api-gateway
    depends_on:
      - auth-service
      - product-service
      - inventory-service
      - order-service
      - user-service
      - cart-service
      - payment-service
      - promotion-service
      - shipping-service
      - notification-service # ── NEW ──
    networks:
      - ecommerce-network

  bff-service:
    build:
      context: .
      dockerfile: services/bff-service/Dockerfile
    restart: unless-stopped
    volumes:
      - ./services/bff-service:/app
      - ./docs:/docs:ro
    ports:
      - "8088:8088"
    env_file:
      - .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_EC2_METADATA_DISABLED=true
      - CLOUDWATCH_ENABLED=true
      - CLOUDWATCH_LOG_GROUP=/ecommerce/services
      - CLOUDWATCH_NAMESPACE=ECommerce
      - REDIS_URL=redis://redis:6379/0
      - REQUEST_TIMEOUT=40s
      - API_GATEWAY_URL=http://api-gateway:8080
      # ── NEW: downstream service URLs for admin aggregation (Feature 9) ──
      - ANALYTICS_SERVICE_URL=http://analytics-service:8093
      - NOTIFICATION_SERVICE_URL=http://notification-service:8092
      - REVIEW_SERVICE_URL=http://review-service:8094
      - PROMOTION_SERVICE_URL=http://promotion-service:8090
      - SHIPPING_SERVICE_URL=http://shipping-service:8091
      # ── NEW: Jaeger tracing ──
      # - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      # - OTEL_SERVICE_NAME=bff-service
    depends_on:
      - api-gateway
      - redis
    networks:
      - ecommerce-network

  stripe-cli:
    image: stripe/stripe-cli:latest
    restart: unless-stopped
    command: listen --forward-to http://api-gateway:8080/stripe/webhook
    env_file:
      - .env
    depends_on:
      - api-gateway
    networks:
      - ecommerce-network

  # ── docs port changed: 8089 was taken by notification-service ───────────────
  docs:
    image: swaggerapi/swagger-ui:latest
    restart: unless-stopped
    ports:
      - "8099:8080" # ← changed from 8089 to 8099
    volumes:
      - ./docs/openapi.yaml:/tmp/openapi.yaml:ro
    environment:
      - SWAGGER_JSON=/tmp/openapi.yaml
    networks:
      - ecommerce-network

networks:
  ecommerce-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  # opensearch_data: # ── NEW ──
