openapi: 3.0.3
info:
  title: Ecommerce Backend API
  version: 1.0.0
  description: |
    OpenAPI specification for the API Gateway, BFF (Backend-for-Frontend), and all backend microservices of the ecommerce platform.

    ## Architecture Overview
    The system is composed of the following layers:
    - **API Gateway** (`:8080`) â€” Single ingress point. Validates JWT access tokens from the `access_token` cookie, enforces role-based access control, and proxies requests to the appropriate downstream service.
    - **BFF Service** (`:8088`) â€” Aggregates data from multiple services into single, page-optimised responses for the web frontend. All BFF endpoints also flow through the Gateway.
    - **Auth Service** (`:8081`) â€” Issues and validates JWT access tokens (short-lived) and refresh tokens (long-lived). Both tokens are delivered as HttpOnly cookies.
    - **User Service** (`:8085`) â€” Manages user profiles and credential changes.
    - **Product Service** (`:8082`) â€” Product catalogue, category tree, bulk import/export, and presigned S3 upload URLs.
    - **Cart Service** (`:8086`) â€” Per-user shopping cart and checkout initiation.
    - **Order Service** (`:8083`) â€” Order lifecycle management.
    - **Payment Service** (`:8087`) â€” Stripe payment session creation, verification, and webhook ingestion.
    - **Inventory Service** â€” Stock management, reservation, release, and confirmation as part of the order saga.
    - **Promotion Service** (`:8090`) â€” Coupon and discount management.
    - **Shipping Service** (`:8091`) â€” Carrier rates, label creation, and shipment tracking via Shippo.

    ## Authentication
    All protected endpoints require a valid JWT `access_token` cookie issued by the Auth Service. The gateway rejects missing or expired tokens with `401 Unauthorized`. Refresh the token via `POST /auth/refresh` before it expires.

    ## Role-Based Access Control
    | Role    | Description                                          |
    |---------|------------------------------------------------------|
    | `user`  | Standard registered customer                         |
    | `admin` | Platform administrator â€” full catalogue & order mgmt |

    Endpoints restricted to `admin` are marked with the ğŸ” **Admin Only** tag. Calling them with a `user` token returns `403 Forbidden`.

    ## Idempotency
    State-mutating operations that must be safe to retry accept an optional `Idempotency-Key` header. Supplying the same key within the deduplication window returns the cached original response without re-executing the operation.

    ## Error Responses
    All errors follow the `ErrorResponse` schema: `{ "error": "...", "details": "..." }`.

    ## Price Representation
    Product prices are stored as floating-point numbers in the store's base currency (e.g. GBP). Order and payment amounts are stored as integers in the smallest currency unit (e.g. pence for GBP, cents for USD) to avoid floating-point rounding errors. Clients must divide order amounts by 100 to display them.

servers:
  - url: http://localhost:8080
    description: API Gateway (primary ingress â€” use this in production)
  - url: http://localhost:8088
    description: BFF Service
  - url: http://localhost:8081
    description: Auth Service
  - url: http://localhost:8085
    description: User Service
  - url: http://localhost:8082
    description: Product Service
  - url: http://localhost:8086
    description: Cart Service
  - url: http://localhost:8083
    description: Order Service
  - url: http://localhost:8087
    description: Payment Service
  - url: http://localhost:8090
    description: Promotion Service
  - url: http://localhost:8091
    description: Shipping Service

tags:
  - name: Gateway
    description: |
      Endpoints exposed by the API Gateway. The gateway handles JWT validation, role enforcement,
      and reverse-proxying to downstream services.
  - name: BFF
    description: |
      Backend-for-Frontend aggregation endpoints. These combine calls to multiple microservices
      into single, page-optimised responses for the web frontend. All BFF routes are also proxied
      through the Gateway.
  - name: Auth Service
    description: |
      Authentication and session management. Issues HttpOnly cookie-based JWT access tokens and
      refresh tokens. Handles registration, login, logout, token refresh, email verification,
      and auth status checks.
  - name: User Service
    description: |
      User profile management. Allows authenticated users to view and update their profile and
      change their password.
  - name: Product Service
    description: |
      Product catalogue and category management. Public read endpoints are available to all.
      Write operations (create, update, delete, bulk import) are restricted to administrators.
  - name: Cart Service
    description: |
      Shopping cart management. Each cart is scoped to an authenticated user. Supports
      adding/removing items and initiating checkout.
  - name: Order Service
    description: |
      Order lifecycle management. Customers can view their own orders. Administrators can view
      all orders across users.
  - name: Payment Service
    description: |
      Payment processing via Stripe. Handles checkout session creation (via cart checkout),
      payment verification, status polling, and webhook ingestion from Stripe.
  - name: Inventory Service
    description: |
      Internal inventory management. Tracks stock levels per product and implements the
      reserve â†’ confirm / release saga pattern used during checkout. Most endpoints are
      intended for internal service-to-service calls, not direct frontend usage.
  - name: Promotion Service
    description: |
      Coupon and promotion management. Supports creating, validating, retrieving, and
      deactivating discount coupons. Coupon types include percentage, flat, and free-shipping
      discounts. Publishes a `coupon_applied` SNS event when a coupon is successfully applied.
  - name: Shipping Service
    description: |
      Shipping management. Provides real-time carrier rates via Shippo, creates shipping labels,
      and tracks shipments. Publishes `shipment_created` and `shipment_updated` SNS events.
  - name: Admin Only
    description: |
      ğŸ” Endpoints in this group require the caller to have the `admin` role. Requests from
      `user`-role tokens will receive `403 Forbidden`.

paths:
  # â”€â”€ Gateway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /health:
    get:
      tags:
        - Gateway
      summary: Gateway health check
      description: |
        Returns the operational status of the API Gateway. Used by load balancers and
        orchestration platforms (e.g. Kubernetes liveness probes) to determine whether the
        gateway is healthy and ready to serve traffic. Does **not** require authentication.
      operationId: healthCheck
      security: []
      responses:
        "200":
          description: Gateway is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: ok
                message: API Gateway is running

  # â”€â”€ BFF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /bff/home:
    get:
      tags:
        - BFF
      summary: Home page â€” aggregated products & categories
      description: |
        Returns a single aggregated payload containing the product list (with default pagination)
        and the full category tree. Designed to populate the storefront home page in a single
        round trip. No authentication required.
      operationId: bffGetHome
      security: []
      responses:
        "200":
          description: Aggregated home page data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BFFHomeResponse"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/profile:
    get:
      tags:
        - BFF
      summary: Profile page â€” user profile & order history
      description: |
        Returns a combined payload containing the authenticated user's profile information and
        their order history. Requires a valid `access_token` cookie. Designed to populate the
        "My Account" / profile page in a single round trip.
      operationId: bffGetProfile
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Aggregated profile page data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BFFProfileResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/auth/register:
    post:
      tags:
        - BFF
      summary: Register a new user account
      description: |
        Creates a new user account. On success a verification email is sent to the provided
        address. The user must verify their email before they can log in (if email verification
        is enforced). Returns `409 Conflict` if the email is already registered.
      operationId: bffRegister
      security: []
      requestBody:
        $ref: "#/components/requestBodies/RegisterRequest"
      responses:
        "201":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/auth/login:
    post:
      tags:
        - BFF
      summary: Login and receive auth cookies
      description: |
        Authenticates a user with email and password. On success, sets two HttpOnly cookies:
        - `access_token` â€” short-lived JWT (e.g. 15 min) used to authenticate subsequent API requests.
        - `refresh_token` â€” long-lived token (e.g. 7 days) used exclusively with `POST /auth/refresh`
          to obtain a new access token.

        Returns `401 Unauthorized` for invalid credentials or unverified accounts.
      operationId: bffLogin
      security: []
      requestBody:
        $ref: "#/components/requestBodies/LoginRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
          headers:
            Set-Cookie: &authCookieHeader
              description: HttpOnly auth cookies set on successful authentication.
              schema:
                type: string
              example: "access_token=eyJ...; HttpOnly; Secure; SameSite=Strict; Path=/"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/auth/logout:
    post:
      tags:
        - BFF
      summary: Logout and clear auth cookies
      description: |
        Invalidates the current session and clears both `access_token` and `refresh_token`
        cookies on the client. Safe to call even if the user is not currently authenticated.
      operationId: bffLogout
      security: []
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/auth/refresh:
    post:
      tags:
        - BFF
      summary: Refresh the access token using the refresh cookie
      description: |
        Issues a new `access_token` cookie using the `refresh_token` cookie. Call this when an
        API request returns `401 Unauthorized` due to an expired access token. Returns `401` if
        the refresh token is missing, expired, or revoked.
      operationId: bffRefreshToken
      security: []
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
          headers:
            Set-Cookie: *authCookieHeader
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/auth/status:
    get:
      tags:
        - BFF
      summary: Check authentication status
      description: |
        Returns whether the current request is authenticated and, if so, the basic identity of
        the authenticated user (ID, email, role). Useful for initialising client-side auth state
        on page load.
      operationId: bffGetAuthStatus
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Current authentication status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthStatusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/auth/verify-email:
    post:
      tags:
        - BFF
      summary: Verify email address with OTP code
      description: |
        Verifies a user's email address using the one-time code sent during registration.
        The `email` and `code` fields are both required. Returns `404` if no pending
        verification exists for the given email.
      operationId: bffVerifyEmail
      security: []
      requestBody:
        $ref: "#/components/requestBodies/VerifyEmailRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/products:
    get:
      tags:
        - BFF
      summary: List products with filtering, sorting, and pagination
      description: |
        Returns a paginated list of products. Supports filtering by featured status, one or
        more category IDs, and price range. Sort order can be controlled via the `sort`
        parameter. No authentication required â€” public endpoint.
      operationId: bffListProducts
      security: []
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PerPageParam"
        - $ref: "#/components/parameters/IsFeaturedParam"
        - $ref: "#/components/parameters/CategoryIDsParam"
        - $ref: "#/components/parameters/MinPriceParam"
        - $ref: "#/components/parameters/MaxPriceParam"
        - $ref: "#/components/parameters/SortParam"
      responses:
        "200":
          description: Paginated product list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductListResponse"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/products/{id}:
    get:
      tags:
        - BFF
      summary: Get a single product by ID
      description: |
        Returns full product details for the given product UUID. No authentication required.
        Returns `404` if the product does not exist or has been deleted.
      operationId: bffGetProduct
      security: []
      parameters:
        - $ref: "#/components/parameters/ProductID"
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/categories:
    get:
      tags:
        - BFF
      summary: Get the full category tree
      description: |
        Returns the complete category hierarchy as a nested tree. Each node may contain a
        `children` array of sub-categories. No authentication required.
      operationId: bffListCategories
      security: []
      responses:
        "200":
          description: Nested category tree
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoryListResponse"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/cart:
    get:
      tags:
        - BFF
      summary: Get the current user's cart
      description: |
        Returns the authenticated user's cart contents, including all items and their quantities.
        Returns an empty `items` array if the cart has not been populated yet.
      operationId: bffGetCart
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Current cart
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cart"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/cart/add:
    post:
      tags:
        - BFF
      summary: Add one or more items to the cart
      description: |
        Adds the provided items to the authenticated user's cart. If an item with the same
        `product_id` already exists in the cart, its quantity is incremented by the provided
        amount. Provide an `Idempotency-Key` header to safely retry on network failure without
        duplicating items.
      operationId: bffAddCartItems
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        $ref: "#/components/requestBodies/AddItemsRequest"
      responses:
        "200":
          description: Updated cart after adding items
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cart"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/cart/remove/{product_id}:
    delete:
      tags:
        - BFF
      summary: Remove an item from the cart
      description: |
        Removes the cart line identified by `product_id` entirely (regardless of quantity).
        Returns `404` if the product is not currently in the cart.
      operationId: bffRemoveCartItem
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/ProductIDString"
      responses:
        "200":
          description: Updated cart after removing item
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cart"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/cart/clear:
    delete:
      tags:
        - BFF
      summary: Clear all items from the cart
      description: Removes all items from the authenticated user's cart, returning it to an empty state.
      operationId: bffClearCart
      security:
        - cookieAuth: []
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/cart/checkout:
    post:
      tags:
        - BFF
      summary: Initiate checkout for the current cart
      description: |
        Converts the authenticated user's cart into a pending order and creates a Stripe checkout
        session. Returns the new order ID, initial status, and an optional `checkout_url` to
        redirect the user to Stripe's hosted payment page.

        This operation is idempotent when an `Idempotency-Key` is provided â€” retrying with the
        same key within the deduplication window returns the same order and checkout URL without
        creating a duplicate order. The cart is cleared after a successful checkout initiation.
      operationId: bffCheckout
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "200":
          description: Checkout initiated â€” order created and payment session ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckoutResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/checkout:
    post:
      tags:
        - BFF
      summary: "(Deprecated) Initiate checkout â€” alias for POST /bff/cart/checkout"
      description: |
        Convenience alias for `POST /bff/cart/checkout`. Both routes invoke the same checkout
        logic. **Deprecated** â€” prefer `/bff/cart/checkout` for consistency.
      operationId: bffCheckoutAlias
      deprecated: true
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "200":
          description: Checkout initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckoutResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/orders:
    get:
      tags:
        - BFF
      summary: List the current user's orders
      description: |
        Returns a paginated list of orders belonging to the authenticated user, sorted by
        creation date descending (most recent first).
      operationId: bffListOrders
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
      responses:
        "200":
          description: Paginated order list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/orders/{id}:
    get:
      tags:
        - BFF
      summary: Get order detail
      description: |
        Returns full details for the specified order, including all line items. Users may only
        retrieve their own orders â€” attempting to fetch another user's order returns `404`.
        Administrators can use the Gateway endpoint directly to retrieve any order.
      operationId: bffGetOrder
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/OrderID"
      responses:
        "200":
          description: Full order detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderDetailResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/users/profile:
    put:
      tags:
        - BFF
      summary: Update the authenticated user's profile
      description: |
        Updates mutable profile fields (`name`, `phone_number`) for the authenticated user.
        Partial updates are supported â€” omit fields that should remain unchanged.
      operationId: bffUpdateProfile
      security:
        - cookieAuth: []
      requestBody:
        $ref: "#/components/requestBodies/UpdateProfileRequest"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateProfileResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/users/change-password:
    post:
      tags:
        - BFF
      summary: Change the authenticated user's password
      description: |
        Changes the password for the currently authenticated user. Requires the current password
        (`old_password`) to be provided as confirmation. All active sessions are invalidated
        after a successful password change. Returns `400` if `old_password` is incorrect.
      operationId: bffChangePassword
      security:
        - cookieAuth: []
      requestBody:
        $ref: "#/components/requestBodies/ChangePasswordRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/payment/status/by-order/{order_id}:
    get:
      tags:
        - BFF
      summary: Get payment status for an order
      description: |
        Returns the current payment status for the given order. Can be polled after checkout to
        determine whether payment has been confirmed by Stripe. Only the order owner may query
        payment status; administrators can use the direct Gateway endpoint.
      operationId: bffGetPaymentStatus
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/OrderIDInPath"
      responses:
        "200":
          description: Payment status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentStatusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "502":
          $ref: "#/components/responses/BadGateway"

  /bff/payment/verify-payment:
    post:
      tags:
        - BFF
      summary: Verify payment after Stripe redirect
      description: |
        Called by the frontend after Stripe redirects back to the success URL. Verifies the
        Stripe payment session and syncs the order status. Both `payment_id` and `session_id`
        (from the Stripe redirect query params) are required.
      operationId: bffVerifyPayment
      security:
        - cookieAuth: []
      requestBody:
        $ref: "#/components/requestBodies/VerifyPaymentRequest"
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyPaymentResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          $ref: "#/components/responses/BadGateway"

  # â”€â”€ Auth Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /auth/register:
    post:
      tags:
        - Gateway
        - Auth Service
      summary: Register a new user account
      description: |
        Direct Gateway route to the Auth Service registration endpoint. Creates a user account
        and sends a verification email. Equivalent to `POST /bff/auth/register` but without
        BFF aggregation.
      operationId: authRegister
      security: []
      requestBody:
        $ref: "#/components/requestBodies/RegisterRequest"
      responses:
        "201":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"

  /auth/login:
    post:
      tags:
        - Gateway
        - Auth Service
      summary: Login and receive auth cookies
      description: |
        Direct Gateway route to the Auth Service login endpoint. Authenticates the user and
        sets `access_token` and `refresh_token` HttpOnly cookies.
      operationId: authLogin
      security: []
      requestBody:
        $ref: "#/components/requestBodies/LoginRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
          headers:
            Set-Cookie: *authCookieHeader
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/logout:
    post:
      tags:
        - Gateway
        - Auth Service
      summary: Logout and clear auth cookies
      description: Invalidates the current session and clears auth cookies. Safe to call without an active session.
      operationId: authLogout
      security: []
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"

  /auth/refresh:
    post:
      tags:
        - Gateway
        - Auth Service
      summary: Refresh access token using the refresh cookie
      description: |
        Issues a new `access_token` cookie from a valid `refresh_token` cookie. Call when an
        API request returns `401` due to an expired access token.
      operationId: authRefreshToken
      security: []
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
          headers:
            Set-Cookie: *authCookieHeader
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/status:
    get:
      tags:
        - Gateway
        - Auth Service
      summary: Check authentication status
      description: |
        Returns the authenticated identity (ID, email, role) from the current access token
        cookie. Useful for server-side session hydration.
      operationId: authGetStatus
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Authentication status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthStatusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/verify-email:
    post:
      tags:
        - Gateway
        - Auth Service
      summary: Verify email address with OTP code
      description: Verifies a user's email using the one-time code delivered during registration.
      operationId: authVerifyEmail
      security: []
      requestBody:
        $ref: "#/components/requestBodies/VerifyEmailRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # â”€â”€ User Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /users/profile:
    get:
      tags:
        - Gateway
        - User Service
      summary: Get the authenticated user's profile
      description: |
        Returns full profile data for the currently authenticated user, including name, email,
        phone number, role, and account creation date.
      operationId: getUserProfile
      security:
        - cookieAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfileResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
    put:
      tags:
        - Gateway
        - User Service
      summary: Update the authenticated user's profile
      description: Updates mutable profile fields for the authenticated user. Partial updates are supported.
      operationId: updateUserProfile
      security:
        - cookieAuth: []
      requestBody:
        $ref: "#/components/requestBodies/UpdateProfileRequest"
      responses:
        "200":
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateProfileResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /users/change-password:
    post:
      tags:
        - Gateway
        - User Service
      summary: Change the authenticated user's password
      description: |
        Changes the password, requiring the current password as confirmation. Invalidates all
        active sessions on success.
      operationId: changePassword
      security:
        - cookieAuth: []
      requestBody:
        $ref: "#/components/requestBodies/ChangePasswordRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  # â”€â”€ Product Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /products:
    get:
      tags:
        - Gateway
        - Product Service
      summary: List products
      description: Returns a paginated, filterable product catalogue. Public endpoint â€” no authentication required.
      operationId: listProducts
      security: []
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PerPageParam"
        - $ref: "#/components/parameters/IsFeaturedParam"
        - $ref: "#/components/parameters/CategoryIDsParam"
        - $ref: "#/components/parameters/MinPriceParam"
        - $ref: "#/components/parameters/MaxPriceParam"
        - $ref: "#/components/parameters/SortParam"
      responses:
        "200":
          description: Paginated product list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductListResponse"
    post:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Create a new product
      description: |
        **Admin only.** Creates a new product in the catalogue. Accepts `multipart/form-data`
        to support simultaneous image upload. The `category` field must be a JSON-encoded
        string array of category names. Images are uploaded directly to S3 â€” use the presign
        endpoints to obtain pre-signed upload URLs for large files instead.
      operationId: createProduct
      security:
        - cookieAuth:
            - admin
      requestBody:
        $ref: "#/components/requestBodies/CreateProductRequest"
      responses:
        "201":
          description: Product created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /products/{id}:
    get:
      tags:
        - Gateway
        - Product Service
      summary: Get product by ID
      description: |
        Returns full product details. Public endpoint â€” no authentication required. Returns
        `404` if the product does not exist or is inactive.
      operationId: getProduct
      security: []
      parameters:
        - $ref: "#/components/parameters/ProductID"
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Update a product
      description: |
        **Admin only.** Performs a partial update on the specified product. Only the fields
        provided in the request body are updated; all other fields retain their current values.
      operationId: updateProduct
      security:
        - cookieAuth:
            - admin
      parameters:
        - $ref: "#/components/parameters/ProductID"
      requestBody:
        $ref: "#/components/requestBodies/UpdateProductRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Delete a product
      description: |
        **Admin only.** Permanently deletes the specified product from the catalogue. This
        action is irreversible. Any carts or orders referencing the product are unaffected but
        the product detail will no longer be resolvable.
      operationId: deleteProduct
      security:
        - cookieAuth:
            - admin
      parameters:
        - $ref: "#/components/parameters/ProductID"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /products/presign:
    get:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Get a presigned S3 upload URL for a new product (by SKU)
      description: |
        **Admin only.** Returns a presigned S3 `PUT` URL and any required form fields for
        uploading a product image before the product record is created. Provide the `sku` query
        parameter to namespace the object key. The presigned URL expires after a short window
        (typically 15 minutes).
      operationId: getProductPresignUrl
      security:
        - cookieAuth:
            - admin
      parameters:
        - name: sku
          in: query
          required: true
          description: The SKU of the product the image belongs to.
          schema:
            type: string
          example: WIDGET-001
      responses:
        "200":
          description: Presigned upload URL and form fields
          content:
            application/json:
              schema:
                type: object
                properties:
                  upload_url:
                    type: string
                    description: The presigned S3 PUT URL.
                    example: "https://s3.amazonaws.com/bucket/..."
                  fields:
                    type: object
                    description: Additional form fields required by the presigned POST policy.
                    additionalProperties:
                      type: string
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /products/{id}/images/presign:
    post:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Get a presigned S3 upload URL for an existing product image
      description: |
        **Admin only.** Returns a presigned S3 `PUT` URL for uploading a new or replacement
        image for an existing product. After upload, update the product record with the
        resulting image URL via `PUT /products/{id}`.
      operationId: getProductImagePresignUrl
      security:
        - cookieAuth:
            - admin
      parameters:
        - $ref: "#/components/parameters/ProductID"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - filename
              properties:
                filename:
                  type: string
                  description: Original filename (used to derive the S3 object key and content type).
                  example: front-view.jpg
      responses:
        "200":
          description: Presigned upload URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  upload_url:
                    type: string
                    example: "https://s3.amazonaws.com/bucket/products/..."
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /products/bulk/validate:
    post:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Validate a product bulk import CSV (dry run)
      description: |
        **Admin only.** Accepts a CSV file and validates it against the product schema without
        writing any data. Returns counts of valid/invalid rows, missing categories, duplicate
        SKUs, field-level errors, and warnings. Use this endpoint to preview issues before
        running the actual import.
      operationId: bulkValidateProducts
      security:
        - cookieAuth:
            - admin
      requestBody:
        $ref: "#/components/requestBodies/BulkValidateRequest"
      responses:
        "200":
          description: Dry-run validation results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BulkImportValidation"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /products/bulk:
    post:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Bulk import products from CSV
      description: |
        **Admin only.** Imports products from a CSV file. Processing is asynchronous â€” the
        response includes a job ID that can be polled via `GET /products/bulk/jobs/{id}`.
        If `auto_create_categories` is `true`, any categories referenced in the CSV that don't
        yet exist will be created automatically.
      operationId: bulkImportProducts
      security:
        - cookieAuth:
            - admin
      requestBody:
        $ref: "#/components/requestBodies/BulkImportRequest"
      responses:
        "202":
          description: Bulk import job queued â€” poll `GET /products/bulk/jobs/{id}` for status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BulkImportResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /products/bulk/jobs/{id}:
    get:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Get bulk import job status and result
      description: |
        **Admin only.** Polls the status of an asynchronous bulk import job. Returns the final
        `inserted_count`, `errors_count`, and per-row error details once the job is complete.
      operationId: getBulkImportJob
      security:
        - cookieAuth:
            - admin
      parameters:
        - name: id
          in: path
          required: true
          description: Bulk import job ID returned by `POST /products/bulk`.
          schema:
            type: string
      responses:
        "200":
          description: Bulk import job result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BulkImportResult"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /products/bulk/delete:
    post:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Bulk delete products
      description: |
        **Admin only.** Deletes multiple products in a single operation. Supports three
        mutually exclusive targeting modes:
        - **`ids`** â€” delete specific products by UUID array.
        - **`category_ids`** â€” delete all products belonging to the specified categories.
        - **`delete_all: true`** â€” delete every product in the catalogue. **Use with extreme caution.**

        Returns the count of deleted records.
      operationId: bulkDeleteProducts
      security:
        - cookieAuth:
            - admin
      requestBody:
        $ref: "#/components/requestBodies/BulkDeleteRequest"
      responses:
        "200":
          description: Number of deleted products
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted_count:
                    type: integer
                    example: 42
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /products/internal/{id}:
    get:
      tags:
        - Product Service
      summary: "Internal â€” fetch product DTO by ID (service-to-service only)"
      description: |
        **Internal endpoint.** Used by other microservices (e.g. Cart, Order) for
        service-to-service product lookups. Not exposed through the public API Gateway. Do
        **not** call this endpoint from client applications. Access is restricted at the network
        level (not via JWT).
      operationId: internalGetProduct
      parameters:
        - $ref: "#/components/parameters/ProductID"
      responses:
        "200":
          description: Product DTO
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          $ref: "#/components/responses/NotFound"

  # â”€â”€ Categories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /categories:
    get:
      tags:
        - Gateway
        - Product Service
      summary: Get full category tree
      description: Returns the complete nested category tree. Public endpoint â€” no authentication required.
      operationId: listCategories
      security: []
      responses:
        "200":
          description: Nested category tree
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoryListResponse"
    post:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Create a category
      description: |
        **Admin only.** Creates a new product category. To create a sub-category, provide one
        or more `parent_ids`. The `slug` must be unique across all categories.
      operationId: createCategory
      security:
        - cookieAuth:
            - admin
      requestBody:
        $ref: "#/components/requestBodies/CreateCategoryRequest"
      responses:
        "201":
          description: Category created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Category"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /categories/{id}:
    put:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Update a category
      description: |
        **Admin only.** Updates the specified category. Partial updates are supported. Note that
        changing `parent_ids` will affect all products whose `category_path` includes this category.
      operationId: updateCategory
      security:
        - cookieAuth:
            - admin
      parameters:
        - $ref: "#/components/parameters/CategoryID"
      requestBody:
        $ref: "#/components/requestBodies/CreateCategoryRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags:
        - Gateway
        - Product Service
        - Admin Only
      summary: ğŸ” Delete a category
      description: |
        **Admin only.** Deletes the specified category. Products that were exclusively in this
        category should be re-assigned before deletion to avoid orphaned catalogue entries.
      operationId: deleteCategory
      security:
        - cookieAuth:
            - admin
      parameters:
        - $ref: "#/components/parameters/CategoryID"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # â”€â”€ Cart Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /cart:
    get:
      tags:
        - Gateway
        - Cart Service
      summary: Get the current user's cart
      description: Returns the cart for the authenticated user. Returns an empty `items` array if no cart exists yet.
      operationId: getCart
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Current cart
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cart"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /cart/add:
    post:
      tags:
        - Gateway
        - Cart Service
      summary: Add items to the cart
      description: |
        Adds one or more items to the cart. Existing items have their quantity incremented
        rather than replaced. Use `Idempotency-Key` to prevent duplicate additions on retry.
      operationId: addCartItems
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        $ref: "#/components/requestBodies/AddItemsRequest"
      responses:
        "200":
          description: Updated cart
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cart"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /cart/remove/{product_id}:
    delete:
      tags:
        - Gateway
        - Cart Service
      summary: Remove an item from the cart
      description: Removes the cart line for the given `product_id`. Returns `404` if the product is not in the cart.
      operationId: removeCartItem
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/ProductIDString"
      responses:
        "200":
          description: Updated cart
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cart"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /cart/clear:
    delete:
      tags:
        - Gateway
        - Cart Service
      summary: Clear all cart items
      description: Removes all items from the authenticated user's cart.
      operationId: clearCart
      security:
        - cookieAuth: []
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /cart/checkout:
    post:
      tags:
        - Gateway
        - Cart Service
      summary: Initiate checkout
      description: |
        Converts the cart into a pending order and creates a Stripe payment session. Returns the
        new `order_id`, `status`, and an optional `checkout_url` for the hosted Stripe payment
        page. The cart is cleared on success. Use `Idempotency-Key` to safely retry without
        creating duplicate orders.
      operationId: checkout
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      responses:
        "200":
          description: Checkout initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckoutResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # â”€â”€ Order Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /orders:
    get:
      tags:
        - Gateway
        - Order Service
      summary: List the current user's orders
      description: |
        Returns a paginated list of the authenticated user's orders. Results are sorted by
        creation date descending.
      operationId: listOrders
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
      responses:
        "200":
          description: Paginated order list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      tags:
        - Gateway
      summary: Create order directly (if enabled)
      description: |
        Creates an order directly from a list of items, bypassing the cart flow. This route may
        be disabled in production environments where the cart â†’ checkout flow is the only
        supported path. Use `POST /cart/checkout` for the standard checkout flow.
      operationId: createOrder
      security:
        - cookieAuth: []
      requestBody:
        $ref: "#/components/requestBodies/CreateOrderRequest"
      responses:
        "202":
          $ref: "#/components/responses/AcceptedResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /orders/admin:
    get:
      tags:
        - Gateway
        - Order Service
        - Admin Only
      summary: ğŸ” Admin â€” list all orders across all users
      description: |
        **Admin only.** Returns a paginated list of all orders placed on the platform,
        regardless of user. Useful for fulfilment, customer service, and reporting dashboards.

        > **Router note:** This path (`/orders/admin`) is a static segment and must be registered
        > *before* `/orders/{id}` in your router to prevent `admin` being treated as an order ID.
      operationId: adminListOrders
      security:
        - cookieAuth:
            - admin
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/LimitParam"
      responses:
        "200":
          description: All orders (paginated)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /orders/{id}:
    get:
      tags:
        - Gateway
        - Order Service
      summary: Get order by ID
      description: |
        Returns full order detail including all line items. Customers can only retrieve their
        own orders. Administrators can retrieve any order. Returns `404` for orders belonging
        to other users (from a customer's perspective).
      operationId: getOrder
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/OrderID"
      responses:
        "200":
          description: Full order detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderDetailResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # â”€â”€ Payment Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /payment/status/by-order/{order_id}:
    get:
      tags:
        - Gateway
        - Payment Service
      summary: Get payment status by order ID
      description: |
        Returns the payment status for the given order. Poll this endpoint after checkout to
        confirm whether the Stripe payment succeeded, is still pending, or failed. Returns
        `checkout_url` if a retry is needed.
      operationId: getPaymentStatus
      security:
        - cookieAuth: []
      parameters:
        - $ref: "#/components/parameters/OrderIDInPath"
      responses:
        "200":
          description: Payment status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentStatusResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /payment/verify-payment:
    post:
      tags:
        - Gateway
        - Payment Service
      summary: Verify payment after Stripe redirect
      description: |
        Verifies a Stripe payment session after the user is redirected back to the site. Supply
        the `payment_id` and `session_id` from the Stripe redirect query string. On success, the
        associated order status is updated to reflect the confirmed payment.
      operationId: verifyPayment
      security:
        - cookieAuth: []
      requestBody:
        $ref: "#/components/requestBodies/VerifyPaymentRequest"
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyPaymentResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /stripe/webhook:
    post:
      tags:
        - Gateway
        - Payment Service
      summary: Stripe webhook receiver
      description: |
        Receives webhook events from Stripe (e.g. `payment_intent.succeeded`,
        `checkout.session.completed`, `payment_intent.payment_failed`). The gateway forwards
        the raw request body and `Stripe-Signature` header to the Payment Service for signature
        verification and event processing.

        **This endpoint must not be called by the frontend.** It is exclusively for Stripe's
        webhook delivery. Configure your Stripe dashboard to send events to this URL.
      operationId: stripeWebhook
      security: []
      parameters:
        - name: Stripe-Signature
          in: header
          required: true
          description: |
            Webhook signature generated by Stripe for payload verification. Must be validated
            using your Stripe webhook secret before processing the event. Requests with a
            missing or invalid signature should be rejected with `400`.
          schema:
            type: string
          example: "t=1714000000,v1=abc123..."
      requestBody:
        description: Raw Stripe webhook event payload
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Stripe event object. See Stripe documentation for full schema.
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

  # â”€â”€ Inventory Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /inventory/{productId}:
    get:
      tags:
        - Inventory Service
        - Admin Only
      summary: ğŸ” Get stock level for a product
      description: |
        **Admin only (or internal service call).** Returns the current on-hand stock quantity
        for a single product. Used by the admin dashboard and internal services for stock
        visibility.
      operationId: getStock
      security:
        - cookieAuth:
            - admin
      parameters:
        - name: productId
          in: path
          required: true
          description: UUID of the product to query.
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Current stock level
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StockResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      tags:
        - Inventory Service
        - Admin Only
      summary: ğŸ” Update stock quantity for a product
      description: |
        **Admin only.** Sets the absolute stock quantity for a product. Use this to correct
        inventory after a stock count or manual adjustment. This is an absolute set, not a
        delta increment.
      operationId: updateStock
      security:
        - cookieAuth:
            - admin
      parameters:
        - name: productId
          in: path
          required: true
          description: UUID of the product to update.
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StockRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /inventory:
    post:
      tags:
        - Inventory Service
        - Admin Only
      summary: ğŸ” Create or upsert stock record for a product
      description: |
        **Admin only.** Creates a new inventory record for a product, or updates the quantity
        if one already exists (upsert). Use when adding a product to inventory for the first
        time or performing a bulk stock-level reset.
      operationId: upsertStock
      security:
        - cookieAuth:
            - admin
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StockRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /inventory/check:
    post:
      tags:
        - Inventory Service
      summary: Check availability for multiple items
      description: |
        Checks whether sufficient stock is available for each item in the request. Returns an
        `available` boolean and the current `available_quantity` for each product. Called by the
        Cart or Order service before initiating checkout to surface out-of-stock errors before
        payment.
      operationId: checkInventory
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InventoryCheckRequest"
      responses:
        "200":
          description: Per-item availability results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InventoryCheckResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

  /inventory/reserve:
    post:
      tags:
        - Inventory Service
      summary: Reserve stock for an order (idempotent)
      description: |
        **Internal â€” order saga step 1.** Temporarily reserves the requested quantities for the
        given `order_id`. This prevents overselling while payment is being processed. The
        reservation must be either confirmed (`POST /inventory/confirm`) on successful payment
        or released (`POST /inventory/release`) on failure or cancellation.

        This operation is idempotent: calling it multiple times with the same `order_id` and
        items has no additional effect.

        > This endpoint is intended for internal service-to-service calls only and should be
        > protected at the network level.
      operationId: reserveStock
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReserveRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"

  /inventory/release:
    post:
      tags:
        - Inventory Service
      summary: Release previously reserved stock
      description: |
        **Internal â€” order saga compensation.** Releases stock that was previously reserved for
        an order. Called when payment fails, the order is cancelled, or a checkout session
        expires. Returns the reserved quantities to the available pool.

        > This endpoint is intended for internal service-to-service calls only and should be
        > protected at the network level.
      operationId: releaseStock
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReleaseRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /inventory/confirm:
    post:
      tags:
        - Inventory Service
      summary: Confirm reserved stock after successful payment
      description: |
        **Internal â€” order saga step 2.** Converts a reservation into a confirmed deduction
        from available stock. Called by the Payment Service (or via Stripe webhook processing)
        once a payment is successfully captured. After confirmation the reservation is closed
        and the stock is permanently decremented.

        > This endpoint is intended for internal service-to-service calls only and should be
        > protected at the network level.
      operationId: confirmStock
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmRequest"
      responses:
        "200":
          $ref: "#/components/responses/MessageResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  # â”€â”€ Promotion Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /coupons:
    post:
      tags:
        - Promotion Service
        - Admin Only
      summary: ğŸ” Create a coupon
      description: "**Admin only.** Creates a new discount coupon."
      operationId: createCoupon
      security:
        - cookieAuth:
            - admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCouponRequest"
      responses:
        "201":
          description: Coupon created
          content:
            application/json:
              schema:
                type: object
                properties:
                  coupon:
                    $ref: "#/components/schemas/Coupon"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Coupon code already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    get:
      tags:
        - Promotion Service
        - Admin Only
      summary: ğŸ” List all coupons
      description: "**Admin only.** Returns a paginated list of all coupons."
      operationId: listCoupons
      security:
        - cookieAuth:
            - admin
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 100
      responses:
        "200":
          description: Coupon list
          content:
            application/json:
              schema:
                type: object
                properties:
                  coupons:
                    type: array
                    items:
                      $ref: "#/components/schemas/Coupon"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /coupons/validate:
    post:
      tags:
        - Promotion Service
      summary: Validate and apply a coupon
      description: |
        Validates a coupon code against the provided cart total. Returns the discount amount.
        If valid, increments the coupon's usage count and publishes a `coupon_applied` SNS
        event. Called by the cart service or frontend during checkout.
      operationId: validateCoupon
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ValidateCouponRequest"
      responses:
        "200":
          description: Validation result (valid or invalid with reason)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidateCouponResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /coupons/{code}:
    get:
      tags:
        - Promotion Service
      summary: Get coupon by code
      description: Returns the details of a single active coupon.
      operationId: getCoupon
      security:
        - cookieAuth: []
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          example: SAVE10
      responses:
        "200":
          description: Coupon details
          content:
            application/json:
              schema:
                type: object
                properties:
                  coupon:
                    $ref: "#/components/schemas/Coupon"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags:
        - Promotion Service
        - Admin Only
      summary: ğŸ” Deactivate a coupon
      description: "**Admin only.** Soft-deactivates a coupon. The coupon record is retained for audit purposes."
      operationId: deactivateCoupon
      security:
        - cookieAuth:
            - admin
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          example: SAVE10
      responses:
        "200":
          description: Coupon deactivated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Coupon deactivated
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # â”€â”€ Shipping Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /shipping/rates:
    post:
      tags:
        - Shipping Service
      summary: Get shipping rates
      description: Returns available carrier rates for the given weight and destination. Requires authentication.
      operationId: getShippingRates
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShippingRatesRequest"
      responses:
        "200":
          description: List of available rates
          content:
            application/json:
              schema:
                type: object
                properties:
                  rates:
                    type: array
                    items:
                      $ref: "#/components/schemas/ShippingRate"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: No rates available
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: Carrier API error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /shipping/labels:
    post:
      tags:
        - Shipping Service
      summary: Create shipping label
      description: |
        Creates a shipping label via Shippo for the selected rate. Returns the shipment record
        with tracking info. Publishes a `shipment_created` SNS event on success.
      operationId: createShippingLabel
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateLabelRequest"
      responses:
        "201":
          description: Shipment created
          content:
            application/json:
              schema:
                type: object
                properties:
                  shipment:
                    $ref: "#/components/schemas/Shipment"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          description: Carrier API error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /shipping/track/{tracking_code}:
    get:
      tags:
        - Shipping Service
      summary: Track a shipment
      description: |
        Returns the current tracking status for a shipment from the carrier. Updates the DB
        record if the status has changed since last poll. Publishes a `shipment_updated` SNS
        event if the status changed.
      operationId: trackShipment
      security:
        - cookieAuth: []
      parameters:
        - name: tracking_code
          in: path
          required: true
          schema:
            type: string
          example: "1Z999AA10123456784"
      responses:
        "200":
          description: Current tracking status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TrackingStatus"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "502":
          description: Carrier API error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

# â”€â”€ Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
      description: |
        JWT access token stored as an HttpOnly cookie. Issued by the Auth Service on login or
        token refresh. Short-lived (typically 15 minutes). Pass the `admin` scope value in the
        `security` declaration to indicate an endpoint requires the `admin` role.

  parameters:
    ProductID:
      name: id
      in: path
      required: true
      description: UUID of the product.
      schema:
        type: string
        format: uuid
      example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1

    ProductIDString:
      name: product_id
      in: path
      required: true
      description: Product ID (string, may be UUID or SKU depending on the service).
      schema:
        type: string
      example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1

    CategoryID:
      name: id
      in: path
      required: true
      description: UUID of the category.
      schema:
        type: string
        format: uuid
      example: 9c2a1c4b-8c5c-4a59-8f1b-1a2b3c4d5e6f

    OrderID:
      name: id
      in: path
      required: true
      description: UUID of the order.
      schema:
        type: string
        format: uuid
      example: f1e2d3c4-b5a6-7890-1234-abcdef123456

    # FIX: separate parameter for paths that use `order_id` (not `id`) as the variable name
    OrderIDInPath:
      name: order_id
      in: path
      required: true
      description: UUID of the order.
      schema:
        type: string
        format: uuid
      example: f1e2d3c4-b5a6-7890-1234-abcdef123456

    PageParam:
      name: page
      in: query
      description: Page number for paginated results (1-indexed).
      schema:
        type: integer
        minimum: 1
        default: 1
      example: 1

    PerPageParam:
      name: perPage
      in: query
      description: Number of items per page.
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 10
      example: 20

    LimitParam:
      name: limit
      in: query
      description: Maximum number of items to return per page.
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 10
      example: 10

    IsFeaturedParam:
      name: is_featured
      in: query
      description: Filter to only featured (`true`) or non-featured (`false`) products.
      schema:
        type: boolean
      example: true

    # FIX: was `type: string` â€” changed to array with proper serialisation style
    CategoryIDsParam:
      name: categoryId
      in: query
      description: |
        One or more category UUIDs to filter by. Products are returned if they belong to
        **any** of the provided categories. Pass multiple values as a comma-separated string
        (e.g. `?categoryId=uuid1,uuid2`).
      style: form
      explode: false
      schema:
        type: array
        items:
          type: string
          format: uuid
      example:
        - 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
        - 9c2a1c4b-8c5c-4a59-8f1b-1a2b3c4d5e6f

    MinPriceParam:
      name: minPrice
      in: query
      description: Minimum product price (inclusive, in the store's base currency).
      schema:
        type: number
        format: float
        minimum: 0
      example: 10.5

    MaxPriceParam:
      name: maxPrice
      in: query
      description: Maximum product price (inclusive, in the store's base currency).
      schema:
        type: number
        format: float
        minimum: 0
      example: 199.99

    SortParam:
      name: sort
      in: query
      description: |
        Sorting order for the product list:
        - `price_asc` / `price_desc` â€” by price
        - `created_at_asc` / `created_at_desc` â€” by creation date
        - `name_asc` / `name_desc` â€” alphabetically by product name
      schema:
        type: string
        enum:
          - price_asc
          - price_desc
          - created_at_asc
          - created_at_desc
          - name_asc
          - name_desc
      example: created_at_desc

    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: |
        Client-generated unique key (e.g. a UUIDv4) to make POST requests idempotent. If a
        request with the same key has already been processed within the deduplication window,
        the original response is returned without re-executing the operation. Strongly
        recommended for checkout and cart mutations to prevent duplicate actions on network retry.
      schema:
        type: string
        format: uuid
      example: 550e8400-e29b-41d4-a716-446655440000

  requestBodies:
    LoginRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/LoginRequest"

    RegisterRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/RegisterRequest"

    VerifyEmailRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/VerifyEmailRequest"

    UpdateProfileRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/UpdateProfileRequest"

    ChangePasswordRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ChangePasswordRequest"

    AddItemsRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/AddItemsRequest"

    CreateOrderRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CreateOrderRequest"

    VerifyPaymentRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/VerifyPaymentRequest"

    CreateProductRequest:
      required: true
      content:
        multipart/form-data:
          schema:
            $ref: "#/components/schemas/CreateProductRequest"

    UpdateProductRequest:
      required: true
      description: |
        Partial product update payload. Only supply the fields you want to change â€” all other
        fields will remain unchanged.
      content:
        application/json:
          schema:
            type: object
            additionalProperties: true
          example:
            price: 29.99
            is_featured: true

    BulkDeleteRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/BulkDeleteRequest"

    CreateCategoryRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/CreateCategoryRequest"

    BulkValidateRequest:
      required: true
      content:
        multipart/form-data:
          schema:
            type: object
            required:
              - file
            properties:
              file:
                type: string
                format: binary
                description: CSV file containing product rows to validate.

    BulkImportRequest:
      required: true
      content:
        multipart/form-data:
          schema:
            type: object
            required:
              - file
            properties:
              file:
                type: string
                format: binary
                description: CSV file containing product rows to import.
              auto_create_categories:
                type: boolean
                default: false
                description: |
                  If `true`, categories referenced in the CSV that do not yet exist will be
                  created automatically. If `false` (default), unknown categories are treated
                  as errors.

  responses:
    MessageResponse:
      description: Generic success message
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/MessageResponse"
          example:
            message: Operation completed successfully.

    AcceptedResponse:
      description: Request accepted for asynchronous processing
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/MessageResponse"
          example:
            message: Order accepted and is being processed.

    BadRequest:
      description: "Bad request â€” the request body or parameters failed validation."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Bad Request
            details: "Field 'email' must be a valid email address."

    Unauthorized:
      description: |
        Unauthorized â€” no valid `access_token` cookie present, or the token has expired.
        Refresh the token via `POST /auth/refresh`.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Unauthorized
            details: Access token is missing or has expired.

    Forbidden:
      description: "Forbidden â€” the authenticated user does not have the required role (`admin`) to access this endpoint."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Forbidden
            details: This endpoint requires the admin role.

    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Not Found
            details: The requested resource could not be found.

    Conflict:
      description: "Conflict â€” the request could not be completed due to a conflict with the current state (e.g. duplicate email on registration)."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Conflict
            details: A user with this email address already exists.

    BadGateway:
      description: "Bad Gateway â€” the BFF or Gateway received an invalid response from an upstream microservice. This typically indicates the downstream service is unavailable or returned an unexpected error."
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Bad Gateway
            details: Upstream service is temporarily unavailable.

  schemas:
    # â”€â”€ Shared / Common â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    PaginationMeta:
      type: object
      description: Pagination metadata returned with paginated list responses.
      properties:
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10
        total:
          type: integer
          format: int64
          example: 42
        total_pages:
          type: integer
          format: int64
          example: 5
        has_more:
          type: boolean
          example: true

    HealthResponse:
      type: object
      description: Gateway health check response.
      properties:
        status:
          type: string
          enum:
            - ok
            - degraded
            - error
          example: ok
        message:
          type: string
          example: API Gateway is running

    MessageResponse:
      type: object
      description: A simple message confirming the outcome of an operation.
      properties:
        message:
          type: string
          example: Operation completed successfully.

    ErrorResponse:
      type: object
      description: Standard error envelope returned for all 4xx and 5xx responses.
      properties:
        error:
          type: string
          description: Short error code or title.
          example: Not Found
        details:
          type: string
          description: Human-readable description of what went wrong.
          example: No product found with the given ID.

    # â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: jane.doe@example.com
        password:
          type: string
          format: password
          minLength: 8
          example: S3cur3P@ssw0rd

    RegisterRequest:
      type: object
      required:
        - name
        - email
        - password
        - role
      properties:
        name:
          type: string
          example: Jane Doe
        email:
          type: string
          format: email
          example: jane.doe@example.com
        password:
          type: string
          format: password
          minLength: 8
          example: S3cur3P@ssw0rd
        role:
          type: string
          enum:
            - user
            - admin
          description: |
            Role assigned to the new account. In production, `admin` accounts should only be
            created by existing administrators or via a seeding script.
          example: user

    VerifyEmailRequest:
      type: object
      required:
        - email
        - code
      properties:
        email:
          type: string
          format: email
          example: jane.doe@example.com
        code:
          type: string
          description: One-time verification code sent to the user's email.
          example: "847291"

    AuthStatusResponse:
      type: object
      description: Current authentication state for the request.
      properties:
        authenticated:
          type: boolean
          example: true
        user:
          type: object
          description: Present only when `authenticated` is `true`.
          properties:
            id:
              type: string
              format: uuid
              example: a1b2c3d4-e5f6-7890-abcd-ef1234567890
            email:
              type: string
              format: email
              example: jane.doe@example.com
            role:
              type: string
              enum:
                - user
                - admin
              example: user
        timestamp:
          type: string
          format: date-time
          example: "2026-02-25T10:00:00Z"

    # â”€â”€ User â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    UserProfileResponse:
      type: object
      description: Full user profile.
      properties:
        id:
          type: string
          format: uuid
          example: a1b2c3d4-e5f6-7890-abcd-ef1234567890
        name:
          type: string
          example: Jane Doe
        email:
          type: string
          format: email
          example: jane.doe@example.com
        phone_number:
          type: string
          nullable: true
          example: "+447911123456"
        created_at:
          type: string
          format: date-time
          example: "2025-01-15T08:30:00Z"
        role:
          type: string
          enum:
            - user
            - admin
          example: user

    UpdateProfileRequest:
      type: object
      description: Fields that can be updated on a user profile. All fields optional.
      properties:
        name:
          type: string
          example: Jane Smith
        phone_number:
          type: string
          example: "+447911123456"

    UpdateProfileResponse:
      type: object
      properties:
        message:
          type: string
          example: Profile updated successfully.
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
              example: a1b2c3d4-e5f6-7890-abcd-ef1234567890
            name:
              type: string
              example: Jane Smith
            phone_number:
              type: string
              nullable: true
              example: "+447911123456"

    ChangePasswordRequest:
      type: object
      required:
        - old_password
        - new_password
      properties:
        old_password:
          type: string
          format: password
          description: The user's current password for verification.
          example: S3cur3P@ssw0rd
        new_password:
          type: string
          format: password
          minLength: 8
          description: The desired new password.
          example: "N3wS3cur3P@ss!"

    # â”€â”€ Product â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Product:
      type: object
      description: A product in the catalogue.
      properties:
        _id:
          type: string
          format: uuid
          description: Unique product identifier.
          example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
        name:
          type: string
          example: Wireless Ergonomic Mouse
        price:
          type: number
          format: float
          description: |
            Price in the store's base currency (e.g. GBP). Note: order amounts are stored as
            integers in the smallest currency unit (pence/cents) â€” see `Order.amount`.
          example: 49.99
        quantity:
          type: integer
          description: Available stock quantity.
          example: 150
        description:
          type: string
          example: A comfortable wireless mouse with ergonomic design.
        images:
          type: array
          description: List of public image URLs for the product.
          items:
            type: string
            format: uri
          example:
            - https://cdn.example.com/products/mouse-front.jpg
            - https://cdn.example.com/products/mouse-side.jpg
        brand:
          type: string
          example: Logitech
        sku:
          type: string
          description: Stock-keeping unit â€” unique per product variant.
          example: LGT-MOUSE-001
        category_ids:
          type: array
          description: UUIDs of all categories this product belongs to.
          items:
            type: string
            format: uuid
          example:
            - 9c2a1c4b-8c5c-4a59-8f1b-1a2b3c4d5e6f
        category_path:
          type: array
          description: 'Human-readable category breadcrumb (e.g. ["Electronics", "Peripherals"]).'
          items:
            type: string
          example:
            - Electronics
            - Peripherals
            - Mice
        is_featured:
          type: boolean
          description: Whether the product is shown in featured/promoted slots.
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-03-01T12:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-01-10T09:15:00Z"

    ProductListResponse:
      type: object
      description: Paginated list of products.
      properties:
        products:
          type: array
          items:
            $ref: "#/components/schemas/Product"
        meta:
          type: object
          description: Pagination metadata.
          properties:
            page:
              type: integer
              example: 1
            perPage:
              type: integer
              example: 10
            total:
              type: integer
              description: Total number of matching products.
              example: 243
            totalPages:
              type: integer
              example: 25

    CreateProductRequest:
      type: object
      description: |
        `multipart/form-data` payload for creating a new product. The `category` field must be
        a JSON-encoded string array, e.g. `["Electronics","Peripherals"]`.
      required:
        - name
        - description
        - brand
        - sku
        - price
        - quantity
        - category
        - images
      properties:
        name:
          type: string
          example: Wireless Ergonomic Mouse
        description:
          type: string
          example: A comfortable wireless mouse with ergonomic design.
        brand:
          type: string
          example: Logitech
        sku:
          type: string
          example: LGT-MOUSE-001
        price:
          type: number
          format: float
          example: 49.99
        quantity:
          type: integer
          example: 150
        is_featured:
          type: boolean
          default: false
          example: true
        category:
          type: string
          description: JSON-encoded array of category name strings.
          example: '["Electronics","Peripherals","Mice"]'
        images:
          type: array
          description: Binary image files to upload with the product.
          items:
            type: string
            format: binary

    # â”€â”€ Category â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Category:
      type: object
      description: A product category node in the category tree.
      properties:
        _id:
          type: string
          format: uuid
          example: 9c2a1c4b-8c5c-4a59-8f1b-1a2b3c4d5e6f
        name:
          type: string
          example: Peripherals
        parent_ids:
          type: array
          description: UUIDs of direct parent categories (empty for root categories).
          items:
            type: string
            format: uuid
        image:
          type: string
          format: uri
          nullable: true
          example: https://cdn.example.com/categories/peripherals.jpg
        ancestors:
          type: array
          description: UUIDs of all ancestor categories from root to immediate parent.
          items:
            type: string
            format: uuid
        slug:
          type: string
          description: URL-friendly unique identifier.
          example: peripherals
        path:
          type: array
          description: Human-readable breadcrumb path from root.
          items:
            type: string
          example:
            - Electronics
            - Peripherals
        level:
          type: integer
          description: Depth in the tree (0 = root).
          example: 1
        is_active:
          type: boolean
          description: Whether the category is visible to customers.
          example: true
        created_at:
          type: string
          format: date-time
          example: "2025-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-06-15T10:30:00Z"
        children:
          type: array
          description: Direct child categories (nested tree structure).
          items:
            $ref: "#/components/schemas/Category"

    CategoryListResponse:
      type: array
      description: Array of root-level categories, each with nested `children`.
      items:
        $ref: "#/components/schemas/Category"

    CreateCategoryRequest:
      type: object
      required:
        - name
      description: Payload for creating or updating a product category.
      properties:
        name:
          type: string
          example: Peripherals
        parent_ids:
          type: array
          description: UUIDs of parent categories. Omit or provide empty array for a root category.
          items:
            type: string
            format: uuid
        image:
          type: string
          format: uri
          nullable: true
          example: https://cdn.example.com/categories/peripherals.jpg
        ancestors:
          type: array
          description: UUIDs of all ancestor categories (from root to immediate parent). Usually computed server-side â€” only provide if known.
          items:
            type: string
            format: uuid
        slug:
          type: string
          description: URL-friendly identifier. Must be unique. Auto-generated from `name` if omitted.
          example: peripherals
        path:
          type: array
          description: Human-readable breadcrumb. Auto-computed server-side if omitted.
          items:
            type: string
        level:
          type: integer
          description: Tree depth (0 = root). Auto-computed server-side if omitted.
          example: 1
        is_active:
          type: boolean
          default: true
          example: true

    # â”€â”€ Cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    CartItem:
      type: object
      description: A single item line in a shopping cart.
      properties:
        product_id:
          type: string
          format: uuid # FIX: was missing format: uuid
          description: UUID of the product.
          example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
        quantity:
          type: integer
          minimum: 1
          example: 2

    Cart:
      type: object
      description: A user's shopping cart.
      properties:
        user_id:
          type: string
          format: uuid
          description: UUID of the cart owner.
          example: a1b2c3d4-e5f6-7890-abcd-ef1234567890
        items:
          type: array
          description: Current items in the cart. Empty array if the cart is empty.
          items:
            $ref: "#/components/schemas/CartItem"
        updated_at:
          type: string
          format: date-time
          description: Timestamp of the last cart modification.
          example: "2026-02-24T12:34:56Z"
      example:
        user_id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
        items:
          - product_id: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
            quantity: 2
        updated_at: "2026-02-24T12:34:56Z"

    AddItemsRequest:
      type: object
      required:
        - items
      description: One or more items to add to the cart.
      properties:
        items:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/CartItem"
      example:
        items:
          - product_id: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
            quantity: 1
          - product_id: 9c2a1c4b-8c5c-4a59-8f1b-1a2b3c4d5e6f
            quantity: 3

    # â”€â”€ Checkout / Order â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    CheckoutResponse:
      type: object
      description: Result of initiating the checkout flow.
      properties:
        order_id:
          type: string
          format: uuid
          description: UUID of the newly created order.
          example: f1e2d3c4-b5a6-7890-1234-abcdef123456
        status:
          type: string
          description: Initial order status. Typically `pending` until payment is confirmed by Stripe webhook.
          enum:
            - pending
            - processing
            - paid
            - failed
            - cancelled
          example: pending
        checkout_url:
          type: string
          format: uri
          nullable: true
          description: |
            URL to Stripe's hosted checkout page. Redirect the user here to complete payment.
            May be `null` if the payment session is still being created asynchronously.
          example: "https://checkout.stripe.com/pay/cs_test_XXXXXXXXXXXXXXXX"

    CreateOrderRequest:
      type: object
      required:
        - items
      description: Direct order creation payload (bypasses cart flow).
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_id
              - quantity
            properties:
              product_id:
                type: string
                format: uuid
                example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
              quantity:
                type: integer
                minimum: 1
                example: 2

    OrderItem:
      type: object
      description: A single line item within an order.
      properties:
        id:
          type: string
          format: uuid
          example: b2c3d4e5-f6a7-8901-bcde-f12345678901
        order_id:
          type: string
          format: uuid
          example: f1e2d3c4-b5a6-7890-1234-abcdef123456
        product_id:
          type: string
          format: uuid
          example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
        quantity:
          type: integer
          example: 2
        price:
          type: integer
          description: |
            Unit price in the smallest currency unit (e.g. pence for GBP, cents for USD) at
            the time the order was placed. Divide by 100 to display.
          example: 4999

    Order:
      type: object
      description: An order record.
      properties:
        id:
          type: string
          format: uuid
          example: f1e2d3c4-b5a6-7890-1234-abcdef123456
        order_number:
          type: string
          description: Human-readable order reference shown to customers.
          example: ORD-20260225-0042
        user_id:
          type: string
          format: uuid
          example: a1b2c3d4-e5f6-7890-abcd-ef1234567890
        amount:
          type: integer
          description: |
            Total order amount in the smallest currency unit (e.g. pence for GBP). Equals the
            sum of (`price` Ã— `quantity`) for all line items. Divide by 100 to display.
          example: 9998
        status:
          type: string
          enum:
            - pending
            - processing
            - paid
            - cancelled
            - completed
            - refunded
          description: |
            Current order lifecycle status:
            - `pending` â€” awaiting payment
            - `processing` â€” payment received, fulfilment in progress
            - `paid` â€” payment confirmed by Stripe
            - `cancelled` â€” order cancelled before fulfilment
            - `completed` â€” order shipped/delivered
            - `refunded` â€” payment refunded
          example: paid
        canceled_at:
          type: string
          format: date-time
          nullable: true
          example: null
        completed_at:
          type: string
          format: date-time
          nullable: true
          example: null
        created_at:
          type: string
          format: date-time
          example: "2026-02-25T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-25T10:05:00Z"
        order_items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"

    OrderListResponse:
      type: object
      description: Paginated list of orders.
      properties:
        orders:
          type: array
          items:
            $ref: "#/components/schemas/Order"
        meta:
          type: object
          properties:
            page:
              type: integer
              example: 1
            limit:
              type: integer
              example: 10
            total_orders:
              type: integer
              example: 37
            total_pages:
              type: integer
              example: 4
            has_more:
              type: boolean
              example: true

    OrderDetailResponse:
      type: object
      description: Wrapper containing a single order's full details.
      properties:
        order:
          $ref: "#/components/schemas/Order"

    # â”€â”€ Payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    PaymentStatusResponse:
      type: object
      description: Payment status for an order.
      properties:
        order_id:
          type: string
          format: uuid
          example: f1e2d3c4-b5a6-7890-1234-abcdef123456
        status:
          type: string
          enum:
            - pending
            - paid
            - failed
            - refunded
          example: paid
        checkout_url:
          type: string
          format: uri
          nullable: true
          description: Retry URL if payment failed and a new session was created.

    VerifyPaymentRequest:
      type: object
      required:
        - payment_id
        - session_id
      description: |
        Payload for verifying a payment after Stripe redirects back. Extract `payment_id` and
        `session_id` from the Stripe success URL query parameters.
      properties:
        payment_id:
          type: string
          description: "Stripe PaymentIntent ID (e.g. `pi_...`)."
          example: pi_3OqAbCDefGhIjKlM0NoPqRsT
        session_id:
          type: string
          description: "Stripe Checkout Session ID (e.g. `cs_test_...`)."
          example: cs_test_a1B2c3D4e5F6g7H8i9J0kL

    VerifyPaymentResponse:
      type: object
      description: Result of the payment verification.
      properties:
        status:
          type: string
          enum:
            - success
            - pending
            - failed
          description: |
            - `success` â€” payment confirmed; order status updated to `paid`.
            - `pending` â€” payment not yet captured (try again shortly).
            - `failed` â€” payment failed; order will be cancelled.
          example: success

    # â”€â”€ BFF aggregated â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    BFFHomeResponse:
      type: object
      description: |
        Aggregated home page payload. Note that `products` is a full `ProductListResponse`
        object (containing a `products` array and `meta`) â€” not a flat array.
      properties:
        products:
          $ref: "#/components/schemas/ProductListResponse"
        categories:
          $ref: "#/components/schemas/CategoryListResponse"
        timestamp:
          type: string
          format: date-time
          description: Server-side timestamp when the response was assembled.
          example: "2026-02-25T10:00:00Z"

    BFFProfileResponse:
      type: object
      description: Aggregated profile page payload.
      properties:
        profile:
          $ref: "#/components/schemas/UserProfileResponse"
        orders:
          $ref: "#/components/schemas/OrderListResponse"
        timestamp:
          type: string
          format: date-time
          example: "2026-02-25T10:00:00Z"

    # â”€â”€ Bulk operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    BulkImportValidation:
      type: object
      description: Dry-run validation results for a bulk product CSV.
      properties:
        totalProducts:
          type: integer
          description: Total number of rows found in the CSV.
          example: 120
        validProducts:
          type: integer
          description: Number of rows that passed validation.
          example: 115
        invalidProducts:
          type: integer
          description: Number of rows that failed validation.
          example: 5
        missingCategories:
          type: array
          description: Category names referenced in the CSV that don't exist in the catalogue.
          items:
            type: string
          example:
            - Wearables
            - Smart Home
        duplicateSKUs:
          type: array
          description: SKUs that appear more than once in the CSV or already exist in the catalogue.
          items:
            type: string
          example:
            - LGT-MOUSE-001
        errors:
          type: array
          description: Per-row validation errors.
          items:
            type: object
            properties:
              row:
                type: integer
                description: 1-indexed row number in the CSV.
              field:
                type: string
                description: The field that failed validation.
              message:
                type: string
        warnings:
          type: array
          description: Non-blocking warnings (rows will still be imported).
          items:
            type: object

    BulkImportResult:
      type: object
      description: Result of a completed bulk product import.
      properties:
        insertedCount:
          type: integer
          description: Number of products successfully inserted.
          example: 115
        errorsCount:
          type: integer
          description: Number of rows that failed to import.
          example: 5
        errors:
          type: array
          description: Per-row import errors for failed rows.
          items:
            type: object
            properties:
              row:
                type: integer
              sku:
                type: string
              message:
                type: string
        message:
          type: string
          description: Human-readable summary of the import result.
          example: "Import complete: 115 inserted, 5 errors."

    BulkDeleteRequest:
      type: object
      description: |
        Identifies products to delete in bulk. Use **exactly one** of the three mutually
        exclusive targeting modes:
        - `ids` â€” list of specific product UUIDs
        - `category_ids` â€” delete all products in these categories
        - `delete_all: true` â€” delete **all** products (use with extreme caution)

        The server will return `400` if more than one mode is supplied simultaneously.
      properties:
        ids:
          type: array
          description: Specific product UUIDs to delete.
          items:
            type: string
            format: uuid
        category_ids:
          type: array
          description: Delete all products belonging to these category UUIDs.
          items:
            type: string
            format: uuid
        delete_all:
          type: boolean
          description: If `true`, deletes every product in the catalogue. Irreversible.
          default: false
      example:
        ids:
          - 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
        category_ids: []
        delete_all: false

    # â”€â”€ Inventory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    StockRequest:
      type: object
      required:
        - product_id
        - quantity
      description: Sets the absolute stock quantity for a product.
      properties:
        product_id:
          type: string
          format: uuid
          example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
        quantity:
          type: integer
          minimum: 0
          description: New absolute stock quantity. Use 0 to mark as out of stock.
          example: 100

    StockResponse:
      type: object
      description: Current stock level for a product.
      properties:
        product_id:
          type: string
          format: uuid
          example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
        quantity:
          type: integer
          description: Current on-hand (unreserved) quantity.
          example: 42

    InventoryCheckRequest:
      type: object
      description: List of items to check stock availability for.
      required:
        - items
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_id
              - quantity
            properties:
              product_id:
                type: string
                format: uuid
                example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
              quantity:
                type: integer
                minimum: 1
                description: Desired quantity to purchase.
                example: 2

    InventoryCheckResponse:
      type: object
      description: Per-item availability results.
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              product_id:
                type: string
                format: uuid
                example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
              available:
                type: boolean
                description: Whether the requested quantity is currently available.
                example: true
              available_quantity:
                type: integer
                description: Current unreserved stock for this product.
                example: 5

    ReserveRequest:
      type: object
      required:
        - order_id
        - items
      description: Request to reserve stock for an order. Part of the order saga pattern. Idempotent on `order_id`.
      properties:
        order_id:
          type: string
          format: uuid
          description: The order for which stock is being reserved.
          example: f1e2d3c4-b5a6-7890-1234-abcdef123456
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_id
              - quantity
            properties:
              product_id:
                type: string
                format: uuid
                example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
              quantity:
                type: integer
                minimum: 1
                example: 2

    ReleaseRequest:
      type: object
      required:
        - order_id
        - items
      description: Request to release a previously created stock reservation. Called when an order is cancelled or payment fails.
      properties:
        order_id:
          type: string
          format: uuid
          description: The order whose reservation should be released.
          example: f1e2d3c4-b5a6-7890-1234-abcdef123456
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_id
              - quantity
            properties:
              product_id:
                type: string
                format: uuid
                example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
              quantity:
                type: integer
                minimum: 1
                example: 2

    ConfirmRequest:
      type: object
      required:
        - order_id
        - items
      description: Request to confirm a stock reservation after successful payment. Converts the reservation into a permanent stock deduction.
      properties:
        order_id:
          type: string
          format: uuid
          description: The order whose reservation should be confirmed.
          example: f1e2d3c4-b5a6-7890-1234-abcdef123456
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - product_id
              - quantity
            properties:
              product_id:
                type: string
                format: uuid
                example: 8a0e4f45-8b2a-4c85-9f0b-9bf8d7c8b4b1
              quantity:
                type: integer
                minimum: 1
                example: 2

    # â”€â”€ Promotion Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Coupon:
      type: object
      description: A promotional coupon.
      properties:
        id:
          type: string
          format: uuid
          example: 3fa85f64-5717-4562-b3fc-2c963f66afa6
        code:
          type: string
          example: SAVE10
        type:
          type: string
          enum:
            - percentage
            - flat
            - freeshipping
          example: percentage
        value:
          type: number
          format: double
          description: "Discount value â€” percentage (0â€“100), flat amount in currency units, or 0 for freeshipping."
          example: 10
        min_order_value:
          type: number
          format: double
          description: Minimum cart total required to apply this coupon.
          example: 50.0
        usage_limit:
          type: integer
          description: Maximum number of times this coupon can be used. 0 = unlimited.
          example: 100
        used_count:
          type: integer
          description: Number of times this coupon has been used.
          example: 5
        expires_at:
          type: string
          format: date-time
          example: "2026-12-31T23:59:59Z"
        active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateCouponRequest:
      type: object
      required:
        - code
        - type
        - value
        - expires_at
      properties:
        code:
          type: string
          minLength: 3
          maxLength: 64
          example: SAVE10
        type:
          type: string
          enum:
            - percentage
            - flat
            - freeshipping
          example: percentage
        value:
          type: number
          format: double
          minimum: 0
          example: 10
        min_order_value:
          type: number
          format: double
          minimum: 0
          default: 0
          example: 50.0
        usage_limit:
          type: integer
          minimum: 0
          default: 0
          description: 0 = unlimited
          example: 100
        expires_at:
          type: string
          format: date-time
          example: "2026-12-31T23:59:59Z"

    ValidateCouponRequest:
      type: object
      required:
        - code
        - cart_total
      properties:
        code:
          type: string
          example: SAVE10
        cart_total:
          type: number
          format: double
          minimum: 0.01
          example: 120.0

    ValidateCouponResponse:
      type: object
      properties:
        valid:
          type: boolean
          example: true
        code:
          type: string
          example: SAVE10
        type:
          type: string
          enum:
            - percentage
            - flat
            - freeshipping
          example: percentage
        discount_amount:
          type: number
          format: double
          example: 12.0
        message:
          type: string
          example: Coupon applied successfully

    # â”€â”€ Shipping Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Address:
      type: object
      properties:
        name:
          type: string
          example: Jane Doe
        street1:
          type: string
          example: 456 Elm St
        street2:
          type: string
          example: Apt 4B
        city:
          type: string
          example: New York
        state:
          type: string
          example: NY
        postal_code:
          type: string
          example: "10001"
        country:
          type: string
          example: US
        phone:
          type: string
          example: "+12125550100"
        email:
          type: string
          format: email
          example: jane@example.com

    ShippingRate:
      type: object
      properties:
        provider:
          type: string
          example: USPS
        service_level:
          type: string
          example: Priority Mail
        amount:
          type: number
          format: double
          example: 9.99
        currency:
          type: string
          example: USD
        estimated_days:
          type: integer
          example: 2
        rate_id:
          type: string
          example: rate_abc123

    ShippingRatesRequest:
      type: object
      required:
        - weight_kg
        - destination
      properties:
        weight_kg:
          type: number
          format: double
          example: 1.5
        destination:
          $ref: "#/components/schemas/Address"

    CreateLabelRequest:
      type: object
      required:
        - order_id
        - user_id
        - rate_id
        - weight_kg
      properties:
        order_id:
          type: string
          example: order-uuid-1234
        user_id:
          type: string
          example: user-uuid-5678
        rate_id:
          type: string
          example: rate_abc123
        weight_kg:
          type: number
          format: double
          example: 1.5
        origin:
          $ref: "#/components/schemas/Address"
        destination:
          $ref: "#/components/schemas/Address"

    Shipment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        order_id:
          type: string
        user_id:
          type: string
        carrier:
          type: string
          example: USPS
        service_level:
          type: string
          example: Priority Mail
        tracking_code:
          type: string
          example: "1Z999AA10123456784"
        label_url:
          type: string
          format: uri
        tracking_url:
          type: string
          format: uri
        status:
          type: string
          enum:
            - created
            - in_transit
            - delivered
            - failure
            - returned
          example: created
        weight_kg:
          type: number
          format: double
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TrackingStatus:
      type: object
      properties:
        tracking_code:
          type: string
        status:
          type: string
          example: TRANSIT
        sub_status:
          type: string
          example: TRANSIT_IN_TRANSIT
        location:
          type: string
          example: "Chicago, IL"
        carrier:
          type: string
          example: USPS
        updated_at:
          type: string
          format: date-time
